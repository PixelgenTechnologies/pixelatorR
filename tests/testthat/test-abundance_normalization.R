pxl_file <- system.file("extdata/five_cells",
                        "five_cells.pxl",
                        package = "pixelatorR")
se <- ReadMPX_Seurat(pxl_file)

test_that("NormalizeMethods work as expected", {
  expect_no_error(
    NormalizationMethod.dsb(LayerData(se, "counts"),
                            isotype_controls = c("mIgG1", "mIgG2a", "mIgG2b")))
  expect_no_error(
    NormalizationMethod.clr(LayerData(se, "counts")))
})

test_that("NormalizeMPX works as expected", {

  # Valid input

  expect_no_error(
    NormalizeMPX(LayerData(se, "counts")))
  expect_no_error(
    NormalizeMPX(se[["mpxCells"]]))
  expect_no_error(
    norm_data_clr <- NormalizeMPX(se, method = "clr"))

  expect_equal(LayerData(norm_data_clr),
               new("dgCMatrix",
                   i = c(0L, 1L, 2L, 3L, 4L, 5L, 6L, 7L, 8L, 9L,
                         10L, 11L, 12L, 13L, 14L, 15L, 16L, 17L, 18L, 19L, 20L, 21L, 22L,
                         23L, 24L, 25L, 26L, 27L, 28L, 29L, 30L, 31L, 32L, 33L, 34L, 35L,
                         36L, 37L, 38L, 39L, 40L, 41L, 42L, 43L, 44L, 45L, 46L, 47L, 48L,
                         49L, 50L, 51L, 52L, 53L, 54L, 55L, 56L, 57L, 58L, 59L, 60L, 61L,
                         62L, 63L, 64L, 65L, 66L, 67L, 68L, 69L, 70L, 71L, 72L, 73L, 74L,
                         75L, 76L, 77L, 78L, 79L, 0L, 1L, 2L, 3L, 4L, 5L, 6L, 7L, 8L,
                         9L, 10L, 11L, 12L, 13L, 14L, 15L, 16L, 17L, 18L, 19L, 20L, 21L,
                         22L, 23L, 24L, 25L, 26L, 27L, 28L, 29L, 30L, 31L, 32L, 33L, 34L,
                         35L, 36L, 37L, 38L, 39L, 40L, 41L, 42L, 43L, 44L, 45L, 46L, 47L,
                         48L, 49L, 50L, 51L, 52L, 53L, 54L, 55L, 56L, 57L, 58L, 59L, 60L,
                         61L, 62L, 63L, 64L, 65L, 66L, 67L, 68L, 69L, 70L, 71L, 72L, 73L,
                         74L, 75L, 76L, 77L, 78L, 79L, 0L, 1L, 2L, 3L, 4L, 5L, 6L, 7L,
                         8L, 9L, 10L, 11L, 12L, 13L, 14L, 15L, 16L, 17L, 18L, 19L, 20L,
                         21L, 22L, 23L, 24L, 25L, 26L, 27L, 28L, 29L, 30L, 31L, 32L, 33L,
                         34L, 35L, 36L, 37L, 38L, 39L, 40L, 41L, 42L, 43L, 44L, 45L, 46L,
                         47L, 48L, 49L, 50L, 51L, 52L, 53L, 54L, 55L, 56L, 57L, 58L, 59L,
                         60L, 61L, 62L, 63L, 64L, 65L, 66L, 67L, 68L, 69L, 70L, 71L, 72L,
                         73L, 74L, 75L, 76L, 77L, 78L, 79L, 0L, 1L, 2L, 3L, 4L, 5L, 6L,
                         7L, 8L, 9L, 10L, 11L, 12L, 13L, 14L, 15L, 16L, 17L, 18L, 19L,
                         20L, 21L, 22L, 23L, 24L, 25L, 26L, 27L, 28L, 29L, 30L, 31L, 32L,
                         33L, 34L, 35L, 36L, 37L, 38L, 39L, 40L, 41L, 42L, 43L, 44L, 45L,
                         46L, 47L, 48L, 49L, 50L, 51L, 52L, 53L, 54L, 55L, 56L, 57L, 58L,
                         59L, 60L, 61L, 62L, 63L, 64L, 65L, 66L, 67L, 68L, 69L, 70L, 71L,
                         72L, 73L, 74L, 75L, 76L, 77L, 78L, 79L, 0L, 1L, 2L, 3L, 4L, 5L,
                         6L, 7L, 8L, 9L, 10L, 11L, 12L, 13L, 14L, 15L, 16L, 17L, 18L,
                         19L, 20L, 21L, 22L, 23L, 24L, 25L, 26L, 27L, 28L, 29L, 30L, 31L,
                         32L, 33L, 34L, 35L, 36L, 37L, 38L, 39L, 40L, 41L, 42L, 43L, 44L,
                         45L, 46L, 47L, 48L, 49L, 50L, 51L, 52L, 53L, 54L, 55L, 56L, 57L,
                         58L, 59L, 60L, 61L, 62L, 63L, 64L, 65L, 66L, 67L, 68L, 69L, 70L,
                         71L, 72L, 73L, 74L, 75L, 76L, 77L, 78L, 79L),
                   p = c(0L, 80L,
                         160L, 240L, 320L, 400L),
                   Dim = c(80L, 5L),
                   Dimnames = list(c("CD274",
                                     "CD44", "CD25", "CD279", "CD41", "HLA-ABC", "CD54", "CD26", "CD27",
                                     "CD38", "CD16", "CD52", "CD53", "CD11c", "CD11a", "CD127", "CD29",
                                     "CD82", "CD45RB", "CD40", "CD19", "CD8", "CD59", "TCRb", "mIgG2a",
                                     "CD11b", "CD86", "CD197", "HLA-DR", "CD3E", "CD2", "CD20", "CD45RA",
                                     "CD14", "CD4", "mIgG2b", "mIgG1", "CD9", "CD69", "B2M", "CD36",
                                     "CD45", "CD152", "CD337", "CD1d", "CD84", "CD161", "CD163", "CD200",
                                     "CD137", "CD229", "CD244", "CD154", "CD18", "CD71", "ACTB", "CD48",
                                     "CD43", "CD150", "CD22", "CD62P", "CD50", "CD33", "CD37", "CD162",
                                     "CD328", "CD7", "CD102", "CD47", "CD72", "CD5", "CD55", "CD278",
                                     "CD32", "CD268", "CD64", "CD49D", "CD158", "CD314", "CD35"),
                                   c("RCVCMP0000217", "RCVCMP0000118", "RCVCMP0000487", "RCVCMP0000655",
                                     "RCVCMP0000263")),
                   x = c(-0.0899921902406002, 1.73625345505862,
                         -0.32638096830483, 0.654448284706896, -1.93581888073893, 5.52082822281565,
                         2.25383586128749, 0.332864660579434, 1.1399561004886, 1.54027980909634,
                         -1.08852102035173, 1.21406407264232, -0.395373839791782, -1.24267170017899,
                         0.101063046522109, -1.64813680828715, 1.487357407642, 1.83310328104854,
                         2.16406586185879, -1.24267170017899, -1.93581888073893, -1.08852102035173,
                         2.72131104417987, 0.101063046522109, 0.0100912683163825, -1.93581888073893,
                         0.143622660940905, 0.935860744145081, 1.57073901658105, 1.98284866740788,
                         2.2073158456526, -0.837206592070821, -0.0899921902406002, -1.64813680828715,
                         3.12677615228804, -0.837206592070821, -1.08852102035173, -0.837206592070821,
                         0.0100912683163825, 4.4577718732117, -0.201217825350824, 4.20979634619631,
                         -0.731846076412995, -1.93581888073893, -0.63653589660867, 0.46207639205944,
                         -1.42499325697294, -1.64813680828715, -0.837206592070821, -1.93581888073893,
                         0.679140897297267, -1.42499325697294, -1.42499325697294, 2.85444678892584,
                         -0.63653589660867, -1.93581888073893, 0.332864660579434, 1.28305694412927,
                         -1.42499325697294, -0.261842447167259, -3.03443116940704, 0.366766212255115,
                         -1.64813680828715, 0.399556035078106, -0.954989627727205, -0.954989627727205,
                         -0.32638096830483, -0.261842447167259, 1.02601184113938, -0.144059411510876,
                         1.25602827174135, -0.54952451961904, -1.24267170017899, -0.201217825350824,
                         -0.954989627727205, -2.3412839888471, 1.25602827174135, -0.954989627727205,
                         -1.64813680828715, -1.42499325697294, -0.728278799753101, 1.23783405661973,
                         -0.88242947958036, -1.98104176824847, 0.270250030358026, 5.90522758578796,
                         2.74634605046387, -1.28789458768852, -1.5755766601403, -0.276293676010044,
                         -2.67418894880841, 1.17595865290164, 0.416853504549902, -0.88242947958036,
                         -0.476964371472195, -1.5755766601403, 0.727008432853741, 2.84727196905383,
                         0.909329989647695, 1.51546579321801, 0.989372697321232, -1.98104176824847,
                         0.93672896383581, 0.159024395247802, -0.476964371472195, -1.98104176824847,
                         0.759798255676732, 0.852171575807747, 4.32432069344219, -1.5755766601403,
                         0.0983997734313666, 3.02959352584779, 2.20861297377796, -1.06475103637431,
                         -1.5755766601403, -1.28789458768852, -1.5755766601403, -1.98104176824847,
                         0.21618280908775, 4.84983246639771, 1.06348066947495, 4.32978518791426,
                         -2.67418894880841, -2.67418894880841, -0.109239591346878, -0.476964371472195,
                         -1.98104176824847, -1.98104176824847, -1.5755766601403, -1.98104176824847,
                         0.822318612658066, -1.98104176824847, -2.67418894880841, 1.35116274192674,
                         -2.67418894880841, -2.67418894880841, 0.503864881539531, -2.67418894880841,
                         -1.5755766601403, 3.55234772047905, -1.5755766601403, 0.852171575807747,
                         -1.98104176824847, 4.06514767854876, -1.5755766601403, -1.06475103637431,
                         -1.06475103637431, 0.503864881539531, 2.07074317955484, 3.9106024435773,
                         0.0338612522937956, 0.544686876059786, -2.67418894880841, 3.77470044533844,
                         0.852171575807747, -1.5755766601403, 0.321543324745576, -1.98104176824847,
                         -1.5755766601403, 3.88684171708816, -0.799819236234203, 1.51271618761301,
                         -0.46334699961299, -1.02296278754841, -0.157965350061808, 6.04903493482777,
                         2.7235957781522, -0.157965350061808, 0.452943732261165, 4.33656726316761,
                         -1.71610996810836, 1.642527799135, -0.269190985172032, -0.537454971766712,
                         0.561157316901398, -0.799819236234203, 1.49271552090634, 2.79474953840849,
                         2.11253142838074, -1.71610996810836, -2.00379204056014, -0.617497679440248,
                         4.10323084718211, -0.537454971766712, -1.02296278754841, -3.10240432922825,
                         -0.394354128126039, 1.6850874135538, 1.51271618761301, 2.82984085821976,
                         3.43862566996165, -3.10240432922825, -1.02296278754841, -1.71610996810836,
                         4.14823118267043, -0.704509056429878, -2.00379204056014, -1.71610996810836,
                         0.74774327248181, 5.00591796094499, -0.617497679440248, 4.77877787299885,
                         -1.31064486000019, -3.10240432922825, -3.10240432922825, -0.106672055674258,
                         -0.329815606988467, -2.00379204056014, -2.00379204056014, -3.10240432922825,
                         -1.31064486000019, -1.02296278754841, -2.00379204056014, 2.62118077272413,
                         -0.617497679440248, -1.49296641679415, 0.561157316901398, -0.394354128126039,
                         -0.269190985172032, -0.905179751892029, -2.00379204056014, -0.329815606988467,
                         -2.4092571486683, 0.394103232238232, 0.363331573571478, -3.10240432922825,
                         1.45147256237229, -0.212032571332084, 2.28666740058825, -1.71610996810836,
                         2.48858265128261, 0.704258160542071, 0.975133114677471, 0.298793052433907,
                         -0.704509056429878, -2.4092571486683, 1.63379411916625, -1.71610996810836,
                         -1.71610996810836, -0.106672055674258, 0.509830230167604, 3.15777650720011,
                         -0.365638507186296, -0.470999022844122, -0.365638507186296, 5.51461511058568,
                         2.23705117825809, 1.28302011840109, 0.663980909994862, 0.0398266009218684,
                         -0.876464130952287, 0.550652224687859, -1.28192923906045, -0.588782058500506,
                         1.7262255544921, 0.104365122059439, 2.26625033295035, 1.86437589297291,
                         2.28053629019783, -0.183316950392341, -1.9750764196204, 4.16048847146134,
                         2.30851014224023, -0.0291662705650833, 0.422818853177974, -1.9750764196204,
                         0.276215378986099, 0.969362559546044, 1.35712809055481, 1.73849564708391,
                         3.1695068469856, -0.470999022844122, -1.05878568774624, -1.9750764196204,
                         -1.05878568774624, -0.876464130952287, -1.56961131151223, -1.56961131151223,
                         0.276215378986099, 4.67390813040438, -0.588782058500506, 4.25442029129555,
                         -1.28192923906045, -2.66822360018034, -1.28192923906045, 0.276215378986099,
                         -1.9750764196204, -1.56961131151223, -2.66822360018034, -2.66822360018034,
                         0.104365122059439, -0.876464130952287, -1.9750764196204, 2.66449519308503,
                         -1.56961131151223, -1.28192923906045, 0.699072229806132, 1.64926451335597,
                         -1.05878568774624, -0.722313451125028, -1.56961131151223, -0.876464130952287,
                         -1.9750764196204, -0.470999022844122, 0.376298837543081, -1.9750764196204,
                         2.58404982786629, -0.270328327381971, 1.26360203254398, -1.05878568774624,
                         1.35712809055481, -0.365638507186296, -1.9750764196204, -0.470999022844122,
                         -1.56961131151223, -1.9750764196204, 1.94689691666092, -2.66822360018034,
                         -1.56961131151223, -1.05878568774624, -0.128021925145374, 2.77196529145023,
                         0.291831920414889, -2.16490385240641, -2.16490385240641, 6.04422313688879,
                         2.86771034840862, 2.6871264115132, -1.65407822864042, 2.05460385276969,
                         0.170471063410622, -1.31760599201921, -0.698566783612987, -0.960931048080478,
                         -0.37314438317836, -1.0662915637383, 2.56248396630593, 1.02694330007387,
                         2.77196529145023, -0.624458811459266, -2.57036896051458, 3.17103037771293,
                         -0.0446403162063236, -0.430302797018308, -0.778609491286524,
                         -2.16490385240641, 3.21345622181516, 0.648506864353622, 5.48906532807236,
                         2.5915557811279, 3.42359246679199, -1.47175667184647, -1.87722177995463,
                         -1.87722177995463, -2.16490385240641, -1.31760599201921, -1.0662915637383,
                         -2.16490385240641, 0.607684869833367, 5.29865041598445, -2.16490385240641,
                         4.47104270328023, -1.47175667184647, -1.87722177995463, -2.57036896051458,
                         0.941176478316442, -2.16490385240641, -3.26351614107452, -1.65407822864042,
                         -2.16490385240641, 0.648506864353622, 1.14320310618973, -1.87722177995463,
                         3.98569891603987, 0.497683974619038, -1.87722177995463, 0.941176478316442,
                         -1.65407822864042, -1.31760599201921, -1.87722177995463, -1.47175667184647,
                         1.45498273022057, -2.57036896051458, 0.400045505055122, 1.6564647847536,
                         -1.31760599201921, 1.55676542453051, 0.607684869833367, 0.941176478316442,
                         -2.57036896051458, 2.62258789037563, -1.18407459939469, 0.374070018651862,
                         -1.65407822864042, -0.490927418834743, -2.57036896051458, 2.13916124079776,
                         -1.87722177995463, 0.814021302831196, -2.16490385240641), factors = list()))

  expect_no_error(
    norm_data_dsb <- NormalizeMPX(se))

  expect_equal(LayerData(norm_data_dsb),
               new("dgCMatrix",
                   i = c(0L, 1L, 2L, 3L, 4L, 5L, 6L, 7L, 8L, 9L,
                         10L, 11L, 12L, 13L, 14L, 15L, 16L, 17L, 18L, 19L, 20L, 21L, 22L,
                         23L, 24L, 25L, 26L, 27L, 28L, 29L, 30L, 31L, 32L, 33L, 34L, 35L,
                         36L, 37L, 38L, 39L, 40L, 41L, 42L, 43L, 44L, 45L, 46L, 47L, 48L,
                         49L, 50L, 51L, 52L, 53L, 54L, 55L, 56L, 57L, 58L, 59L, 60L, 61L,
                         62L, 63L, 64L, 65L, 66L, 67L, 68L, 69L, 70L, 71L, 72L, 73L, 74L,
                         75L, 76L, 77L, 78L, 79L, 0L, 1L, 2L, 3L, 4L, 5L, 6L, 7L, 8L,
                         9L, 10L, 11L, 12L, 13L, 14L, 15L, 16L, 17L, 18L, 19L, 20L, 21L,
                         22L, 23L, 24L, 25L, 26L, 27L, 28L, 29L, 30L, 31L, 32L, 33L, 34L,
                         35L, 36L, 37L, 38L, 39L, 40L, 41L, 42L, 43L, 44L, 45L, 46L, 47L,
                         48L, 49L, 50L, 51L, 52L, 53L, 54L, 55L, 56L, 57L, 58L, 59L, 60L,
                         61L, 62L, 63L, 64L, 65L, 66L, 67L, 68L, 69L, 70L, 71L, 72L, 73L,
                         74L, 75L, 76L, 77L, 78L, 79L, 0L, 1L, 2L, 3L, 4L, 5L, 6L, 7L,
                         8L, 9L, 10L, 11L, 12L, 13L, 14L, 15L, 16L, 17L, 18L, 19L, 20L,
                         21L, 22L, 23L, 24L, 25L, 26L, 27L, 28L, 29L, 30L, 31L, 32L, 33L,
                         34L, 35L, 36L, 37L, 38L, 39L, 40L, 41L, 42L, 43L, 44L, 45L, 46L,
                         47L, 48L, 49L, 50L, 51L, 52L, 53L, 54L, 55L, 56L, 57L, 58L, 59L,
                         60L, 61L, 62L, 63L, 64L, 65L, 66L, 67L, 68L, 69L, 70L, 71L, 72L,
                         73L, 74L, 75L, 76L, 77L, 78L, 79L, 0L, 1L, 2L, 3L, 4L, 5L, 6L,
                         7L, 8L, 9L, 10L, 11L, 12L, 13L, 14L, 15L, 16L, 17L, 18L, 19L,
                         20L, 21L, 22L, 23L, 24L, 25L, 26L, 27L, 28L, 29L, 30L, 31L, 32L,
                         33L, 34L, 35L, 36L, 37L, 38L, 39L, 40L, 41L, 42L, 43L, 44L, 45L,
                         46L, 47L, 48L, 49L, 50L, 51L, 52L, 53L, 54L, 55L, 56L, 57L, 58L,
                         59L, 60L, 61L, 62L, 63L, 64L, 65L, 66L, 67L, 68L, 69L, 70L, 71L,
                         72L, 73L, 74L, 75L, 76L, 77L, 78L, 79L, 0L, 1L, 2L, 3L, 4L, 5L,
                         6L, 7L, 8L, 9L, 10L, 11L, 12L, 13L, 14L, 15L, 16L, 17L, 18L,
                         19L, 20L, 21L, 22L, 23L, 24L, 25L, 26L, 27L, 28L, 29L, 30L, 31L,
                         32L, 33L, 34L, 35L, 36L, 37L, 38L, 39L, 40L, 41L, 42L, 43L, 44L,
                         45L, 46L, 47L, 48L, 49L, 50L, 51L, 52L, 53L, 54L, 55L, 56L, 57L,
                         58L, 59L, 60L, 61L, 62L, 63L, 64L, 65L, 66L, 67L, 68L, 69L, 70L,
                         71L, 72L, 73L, 74L, 75L, 76L, 77L, 78L, 79L),
                   p = c(0L, 80L,
                         160L, 240L, 320L, 400L),
                   Dim = c(80L, 5L),
                   Dimnames = list(c("CD274",
                                     "CD44", "CD25", "CD279", "CD41", "HLA-ABC", "CD54", "CD26", "CD27",
                                     "CD38", "CD16", "CD52", "CD53", "CD11c", "CD11a", "CD127", "CD29",
                                     "CD82", "CD45RB", "CD40", "CD19", "CD8", "CD59", "TCRb", "mIgG2a",
                                     "CD11b", "CD86", "CD197", "HLA-DR", "CD3E", "CD2", "CD20", "CD45RA",
                                     "CD14", "CD4", "mIgG2b", "mIgG1", "CD9", "CD69", "B2M", "CD36",
                                     "CD45", "CD152", "CD337", "CD1d", "CD84", "CD161", "CD163", "CD200",
                                     "CD137", "CD229", "CD244", "CD154", "CD18", "CD71", "ACTB", "CD48",
                                     "CD43", "CD150", "CD22", "CD62P", "CD50", "CD33", "CD37", "CD162",
                                     "CD328", "CD7", "CD102", "CD47", "CD72", "CD5", "CD55", "CD278",
                                     "CD32", "CD268", "CD64", "CD49D", "CD158", "CD314", "CD35"),
                                   c("RCVCMP0000217", "RCVCMP0000118", "RCVCMP0000487", "RCVCMP0000655",
                                     "RCVCMP0000263")),
                   x = c(0.583158270809045, 0.0790780825426958,
                         -0.154725746414455, 1.49282321117081, 0.614776868067649, -0.136067006221542,
                         -0.142910466247053, -0.428538743420969, 2.10875565126872, 0.475837690955558,
                         0.222325664607507, 2.19963654401336, 1.15114081547053, -0.21240471007002,
                         0.219966396243994, 0.0753130137776855, 0.537200550382975, 0.418784838812576,
                         0.899983642572676, 0.564765104246012, 1.03909853560308, -0.00175881114538204,
                         1.69241605526347, 0.339992260469748, 0.72328451777115, 1.02175282590163,
                         -0.296211501522246, -0.0940344362413737, 0.235845763453554, 2.25971537198781,
                         1.38093976796982, 2.14813549028188, 1.67460190635536, 0.634937708374825,
                         2.98583381240698, 0.350280766018795, 0.470275559378443, 0.529963229712881,
                         -0.211864775998167, -0.218948102770932, 1.72213601188922, -0.107732037202062,
                         1.50476443186627, 0.615623668408702, 2.12118788965345, 0.077651326255222,
                         0.0421547277180441, 1.34341589491437, 1.60650474381903, 0.889878694279905,
                         1.35802954307264, -0.690877944910263, 0.880723521977413, 0.194756213920462,
                         0.57924493289477, 0.681603905552287, -0.375690436543843, 2.5891031914661,
                         -0.495868384593574, 1.96977529404523, 0.163483306204575, 0.526986747509899,
                         1.21585422179471, 1.05445627286292, -0.702723140435773, 1.58937904391752,
                         0.11809368239615, -0.155546476274171, 0.012213562011921, 2.75049096690557,
                         -0.377532585540448, 0.30371818635061, -0.40452882746919, 1.51968471323165,
                         0.926004674596612, 0.827750844437239, 0.699790085783957, 1.07623968717,
                         -0.419771158875352, 0.658029157130459, 0.141674339857817, -0.171753260080643,
                         0.111411814794127, 0.101932380510187, 1.01582427804594, 0.480672998470627,
                         0.518036402709986, -0.316437199401998, 0.705307307491039, 1.93333665777273,
                         0.238331128154844, 1.88699381424898, 1.84194532844754, 0.0670965615749557,
                         -0.486271936350142, -0.0513880323774621, 0.597611702752304, 0.803116080084734,
                         0.963729560916127, 0.969176197015489, 1.63852750287243, -0.691254223084473,
                         1.07538146671027, 0.22167845636845, 0.03437131834236, 0.79589221272653,
                         0.918863342914018, 0.173544605736339, 2.52141519385142, 2.23970488926429,
                         1.46910894978641, 2.13555117654877, 1.8864424739501, 0.994877718423843,
                         2.40361843881332, 0.321374186449083, 0.509007303898695, 0.0604886259491779,
                         0.331038239576219, 0.420087330435593, 1.53215854872488, 0.345314216289657,
                         1.07708618075898, 0.652069479057896, 1.30116492062913, 0.149940921136788,
                         0.404662957565837, 0.736434453977782, 1.81980167179917, 0.974902576813356,
                         1.24666372141226, 0.171529347767231, 0.709227890081356, 0.477433954986145,
                         1.15198238883312, 0.562991398964156, -0.0292289269043159, 0.19611650241477,
                         -0.131885713524369, 2.43280752506662, 0.877347579659989, 1.56938013866094,
                         0.923253663815455, 2.43676677665098, 0.0757373491011764, 1.45663798226732,
                         0.0328640778350893, 0.532204243567155, 0.657706068466132, 2.90821299373732,
                         0.346373821470145, 0.783832581357758, 1.02316869358456, 2.32293723452879,
                         2.02645593850029, 0.916887632429604, 0.80011584672414, 1.2530277750601,
                         0.617076084870993, 1.96426435249455, 0.0593901053327171, 0.0523654846610523,
                         0.0269396277277565, 0.223589218874532, 2.15433057618296, 0.585732137010824,
                         0.506895136481635, -0.407687056310832, 1.84422627953871, 4.1105221396023,
                         0.0786085222003802, 2.71424167160851, 1.39592319725892, 0.620035535087006,
                         0.797221215170677, 1.02572946969545, 0.8608877886499, 1.39125384204627,
                         1.27228835926199, -0.263290743764694, 0.622435727688141, 0.65664252654205,
                         3.46617904998495, -0.191554154937138, -0.208221047334692, -0.0387858240770114,
                         -0.562890565835132, 0.873995644093842, 0.222950357467819, 4.00114144421018,
                         3.22234037736463, -0.795097972246318, 0.443605894328933, 0.663936642648762,
                         5.02503977074756, 0.7167295251057, -0.189196428065053, -0.0616456775186525,
                         0.741526013541269, 0.525892661362027, 1.14182468598562, 0.676192466164435,
                         1.39139281224983, -0.242372192585565, -0.485953900693191, -0.13236977519252,
                         1.47639301583662, 1.07399975305109, 0.785998844006391, -0.104756794599261,
                         -0.541376413133417, 0.156184766012046, 0.674721532307637, 0.48442856322809,
                         1.29598886326607, 1.40017576435863, 0.0341370243929789, 1.38763264043078,
                         0.913354159321115, 0.760378886390843, 1.18053440163442, 0.0928180606389785,
                         0.607617318074479, 0.709319299117251, 1.05651601826752, -0.418567554682527,
                         2.17874331584606, 0.0220771574272036, 1.33257554557649, 0.496683186610526,
                         1.41190158548859, 1.57166036660411, 2.56372896081195, 1.49147433311468,
                         1.1710120993912, 0.760693668770098, 1.44126078489836, 0.71444410461784,
                         -0.138989485580779, 1.2715587463404, 1.23777961281461, 1.59378291104827,
                         0.333471374630927, 1.21408432235121, 0.726806355392755, -0.0606221174819133,
                         -0.126334839940614, 1.73734617703121, 2.5304932150378, 1.35593946202493,
                         1.5509624739045, 1.23479166063003, 0.0788740927064615, 0.286520387375939,
                         1.65428724543221, 1.58327450993932, 1.84247042673163, -0.119906297334549,
                         1.91900186783875, -0.248734271715753, -0.851878500477016, 5.30675259686746,
                         2.06808898679959, -0.0174049725836327, 0.889509373017759, 0.752030201499959,
                         0.19507892014487, 0.111009119109664, -0.425423761103703, 4.59570349424779,
                         3.90971437652956, -0.51158137494877, -0.965279840321481, 0.0451793159286515,
                         1.82027065119221, 0.535857829740223, 0.292626079742754, 0.213288791907245,
                         0.214874882682931, 0.0899064711430393, 0.141206994872604, 0.0946701892812833,
                         2.00550121665228, 0.374871900491606, 0.363568394602873, 0.56219749309145,
                         0.0923617847222472, 1.12085664420066, 0.400802207908554, 0.161970901872853,
                         0.49693173732281, 0.83575789369749, 1.05120880124683, 1.26066704651852,
                         1.52512326796645, 1.70995566169397, 0.0291865399861038, 4.04361357748752,
                         0.165299092045731, -1.11739418723984, 0.971308600896957, -0.389221788524744,
                         0.825434394520735, -1.63571139984454, 1.59200353814746, 0.457982861174006,
                         3.42821690831949, -0.316892536689787, -0.145876891550686, -1.20342785903372,
                         1.10043972593066, -0.0704631474535122, 0.93007798681416, -1.24189314398013,
                         -0.316679877321423, 0.588674468006773, 2.07881201971634, 0.178153288888541,
                         0.293606899098902, -2.0970794447947, 0.863241929077271, 1.44101996837564,
                         0.881550999939355, -0.840953856900627, 0.383868338140239, 0.711121074357595,
                         0.784543883447159, 2.48933336046764, -0.18891794260836, 1.80009270100339,
                         2.02396137640501, -0.0892509585077048, 1.1152016036456, 0.343091562436969,
                         0.0119278087286103, 0.911971652756958, 2.0301630682445, -0.201377608265566,
                         2.00526625297377, 1.09345893448798, 0.319498645828981, 4.57690050201753,
                         -0.600274851924871, 0.0671135026407772, 0.188982194472205, 1.05045770176227,
                         3.15599961341274, -0.0385878240464549, 4.36603294977059, 3.72060136784721,
                         3.23502035036431, 1.18023156157595, -0.159480184676736, 0.656800888177875,
                         -1.36069483274652, 0.223951469197942, 0.863197634100474, -0.40329604398997,
                         0.726218802958344, 0.948062483637231, -0.187380401720985, 0.49340431282062,
                         1.29359148754284, 1.08471379441536, 0.258682474573284, 1.00504482119049,
                         -0.264289789324414, -0.0291072247883738, 1.22839095608153, 0.968269970581894,
                         1.57337353111495, 2.39067971611843, 0.88739579277272, 1.89810543866934,
                         2.41732432827382, 1.12591219216726, 0.547323935748345, 0.188632010054064,
                         -0.0195819216387784, 0.105464698586878, 1.89375130764713, 1.99088245473149,
                         0.586723485154289, 0.976685436383657, 2.41899068581973, 1.50974986648465,
                         2.39228660669988, 0.988181461894049, 0.150230627018594, -0.0119781819669378,
                         1.58671360556693, -0.142318678891707, 1.95584018157825, -0.153579848891573,
                         1.56377844778022, 0.777194397264177, 2.03496915644798, 0.632908568705244,
                         2.48316177949796, -0.435407365164816), factors = list()))

  # Invalid input
  expect_error(
    NormalizeMPX(se,
                 method = "invalid_method"),
    regexp = "'arg' should be")
  expect_error(
    NormalizeMPX(se,
                 method = "dsb",
                 isotype_controls = c("isotype_control_that_definitely_does_not_exist",
                                      "isotype_control_that_could_exist_but_does_not")),
    regexp = "All isotype controls must be present in the object")

  expect_error(
    NormalizeMPX(se,
                 method = "dsb",
                 isotype_controls = NULL),
    regexp = "isotype_controls must have at least one element")

})
